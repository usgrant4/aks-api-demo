name: ci-cd

on:
    push:
        branches: [main]
        paths:
            - "app/**"
            - "Dockerfile"
            - "kubernetes/**"
            - "terraform/**"
            - ".github/workflows/ci-cd.yml"
    pull_request:
        paths:
            - "app/**"
            - "Dockerfile"
            - "kubernetes/**"
            - "terraform/**"

env:
    TF_WORKING_DIR: terraform
    APP_NAME: liatrio-demo

jobs:
    build-test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install deps & run tests
              run: |
                  pip install -r app/requirements.txt
                  pytest -v --tb=short

    deploy:
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        needs: build-test
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.6
                  terraform_wrapper: false

            - name: Terraform Init/Apply
              working-directory: ${{ env.TF_WORKING_DIR }}
              run: |
                  terraform init -input=false
                  terraform apply -auto-approve -input=false -compact-warnings

            - name: Fetch outputs
              id: tfout
              working-directory: ${{ env.TF_WORKING_DIR }}
              run: |
                  echo "ACR_LOGIN_SERVER=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
                  echo "ACR_NAME=$(terraform output -raw acr_login_server | cut -d'.' -f1)" >> $GITHUB_OUTPUT
                  echo "RG=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
                  echo "AKS=$(terraform output -raw aks_name)" >> $GITHUB_OUTPUT

            - name: AKS get-credentials
              run: |
                  az aks get-credentials \
                    -g ${{ steps.tfout.outputs.RG }} \
                    -n ${{ steps.tfout.outputs.AKS }} \
                    --overwrite-existing

            - name: ACR login
              run: az acr login --name ${{ steps.tfout.outputs.ACR_NAME }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build & push image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ steps.tfout.outputs.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}:${{ github.sha }}
                      ${{ steps.tfout.outputs.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}:latest
                  cache-from: type=registry,ref=${{ steps.tfout.outputs.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}:buildcache
                  cache-to: type=registry,ref=${{ steps.tfout.outputs.ACR_LOGIN_SERVER }}/${{ env.APP_NAME }}:buildcache,mode=max

            - name: Deploy manifests
              run: |
                  sed "s#REPLACE_WITH_ACR_LOGIN#${{ steps.tfout.outputs.ACR_LOGIN_SERVER }}#" \
                    kubernetes/deployment.yaml | kubectl apply -f -

            - name: Wait for rollout
              run: kubectl rollout status deploy/liatrio-demo --timeout=120s

            - name: Smoke test
              run: |
                  echo "Waiting for LoadBalancer IP allocation..."
                  for i in $(seq 1 20); do
                    IP=$(kubectl get svc liatrio-demo-svc -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
                    if [ -n "$IP" ]; then
                      echo "✓ Service IP acquired: $IP"
                      echo "Testing endpoint..."
                      if curl -sS -f http://$IP/ --connect-timeout 5 --retry 3 --retry-delay 2; then
                        echo ""
                        echo "✓ Smoke test PASSED"
                        exit 0
                      else
                        echo "✗ Endpoint returned error"
                        kubectl get pods -l app=liatrio-demo
                        kubectl logs -l app=liatrio-demo --tail=20
                        exit 1
                      fi
                    fi
                    echo "⏳ Waiting for external IP... (attempt $i/20)"
                    sleep 10
                  done
                  echo "✗ Smoke test FAILED: LoadBalancer IP not available after 200s"
                  kubectl get svc liatrio-demo-svc -o yaml
                  kubectl describe svc liatrio-demo-svc
                  exit 1

    destroy:
        if: github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        permissions:
            id-token: write
            contents: read
        steps:
            - uses: actions/checkout@v4

            - name: Azure login (OIDC)
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: 1.9.6

            - name: Terraform Destroy
              working-directory: terraform
              run: |
                  terraform init -input=false
                  terraform destroy -auto-approve -input=false
